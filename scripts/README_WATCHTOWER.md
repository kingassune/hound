# Watchtower - Batch Scanner for Contract Target Radar

Watchtower is a bridging script that automates Hound security audits for multiple repositories listed in a CSV file from the "Contract Target Radar".

## Features

- **CSV Processing**: Reads repository lists from Contract Target Radar CSV exports
- **Filtering**: Processes only NEW or UPDATED repositories (configurable)
- **Automated Workflow**: 
  - Clones repositories to temporary workspace
  - Creates Hound projects
  - Runs security audits in headless mode
  - Generates HTML reports
- **Organized Output**: Results stored in `Org/Repo/Date` directory structure
- **Logging**: Comprehensive logging to both file and console

## Installation

Watchtower requires Hound to be installed and configured:

```bash
# Install Hound dependencies
pip install -r requirements.txt

# Configure your LLM API keys (see main README)
export OPENAI_API_KEY=your_key_here
# or
export DEEPSEEK_API_KEY=your_key_here
# or
export ANTHROPIC_API_KEY=your_key_here
```

## Usage

### Basic Usage

Process a CSV file with default settings (NEW and UPDATED repos):

```bash
python scripts/watchtower.py examples/sample_radar.csv
```

### Custom Output Directory

Specify where to save audit results:

```bash
python scripts/watchtower.py radar.csv --output-dir ./my_audits
```

### Filter by Status

Process only specific repository statuses:

```bash
# Only NEW repositories
python scripts/watchtower.py radar.csv --filter NEW

# Multiple statuses
python scripts/watchtower.py radar.csv --filter NEW,UPDATED,MODIFIED
```

### Verbose Logging

Enable detailed debug logging:

```bash
python scripts/watchtower.py radar.csv --verbose
```

## CSV Format

The Radar CSV file should contain the following columns (case-insensitive):

| Column | Required | Description |
|--------|----------|-------------|
| status | Yes | Repository status (NEW, UPDATED, etc.) |
| url | Yes | Git repository URL |
| org | Optional | Organization name (inferred from URL if missing) |
| repo | Optional | Repository name (inferred from URL if missing) |

### Example CSV

```csv
org,repo,status,url
ethereum,solidity,NEW,https://github.com/ethereum/solidity
OpenZeppelin,openzeppelin-contracts,UPDATED,https://github.com/OpenZeppelin/openzeppelin-contracts
foundry-rs,foundry,NEW,https://github.com/foundry-rs/foundry
aave,aave-v3-core,UPDATED,https://github.com/aave/aave-v3-core
Uniswap,v3-core,NEW,https://github.com/Uniswap/v3-core
```

A sample CSV is available at `examples/sample_radar.csv`.

## Output Structure

Watchtower organizes results in the following directory structure:

```
watchtower_output/
├── ethereum/
│   └── solidity/
│       └── 2024-12-08/
│           ├── audit_report.html
│           └── repo_info.json
├── OpenZeppelin/
│   └── openzeppelin-contracts/
│       └── 2024-12-08/
│           ├── audit_report.html
│           └── repo_info.json
└── ...
```

- **Org/Repo/Date**: Each audit is organized by organization, repository, and date
- **audit_report.html**: HTML security audit report generated by Hound
- **repo_info.json**: Metadata about the repository from the CSV

## Logging

Watchtower creates two logs:

1. **watchtower.log**: File log with all details
2. **Console output**: Real-time progress and summary

Log levels can be controlled with the `--verbose` flag.

## Command-Line Options

```
positional arguments:
  csv_file              Path to the Radar CSV file

options:
  -h, --help            Show help message and exit
  --output-dir DIR      Directory to store audit results (default: ./watchtower_output)
  --filter STATUS       Comma-separated list of status values to process (default: NEW,UPDATED)
  --verbose, -v         Enable verbose logging
```

## Examples

### Process Sample CSV

Test with the included sample:

```bash
python scripts/watchtower.py examples/sample_radar.csv
```

### Production Run

Process a production Radar export:

```bash
python scripts/watchtower.py /path/to/radar_export.csv \
  --output-dir /var/audits \
  --filter NEW,UPDATED
```

### Single Repository Test

Create a minimal CSV for testing:

```bash
echo "org,repo,status,url" > test.csv
echo "test-org,test-repo,NEW,https://github.com/test-org/test-repo" >> test.csv
python scripts/watchtower.py test.csv
```

## Requirements

- Python 3.8+
- Git installed and available in PATH
- Hound installation with configured API keys
- Internet connection for cloning repositories

## Timeouts and Limits

- **Clone timeout**: 5 minutes per repository
- **Audit timeout**: 1 hour per repository
- **Report timeout**: 5 minutes per repository
- **Max iterations**: 30 per audit (configurable in code)

## Error Handling

Watchtower continues processing even if individual repositories fail:

- Failed clones are logged and skipped
- Failed audits are logged and the script continues
- Summary report shows success/failure counts

## Troubleshooting

### "Git clone failed"

- Verify the repository URL is accessible
- Check internet connection
- Ensure Git is installed: `git --version`

### "Project creation failed"

- Verify Hound is properly installed
- Check that source path exists and is readable
- Review Hound logs for details

### "Audit failed"

- Verify API keys are set: `echo $OPENAI_API_KEY`
- Check that config.yaml is properly configured
- Review audit.log for detailed error messages
- Ensure project has valid source code

### "Report generation failed"

- Verify audit completed successfully
- Check that project has hypotheses data
- Review Hound report command output

## Limitations

- Currently supports GitHub-style URLs
- Requires public repositories or configured Git credentials
- One repository processed at a time (sequential)
- Limited to repositories that Hound can analyze

## Future Enhancements

Potential improvements for future versions:

- Parallel processing of multiple repositories
- Support for private repositories with credentials
- Custom audit parameters per repository
- Email notifications on completion
- Integration with CI/CD pipelines
- Progress dashboard/web UI

## License

This script is part of the Hound project and follows the same license (Apache 2.0).

## Support

For issues or questions:

1. Check the main Hound README
2. Review logs in `watchtower.log`
3. Open an issue on the Hound GitHub repository
